name: Notify Slack After Deploy

on:
  push:
    branches:
      - main

jobs:
  notify-slack:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get latest 5 commit messages
        id: get_commits
        run: |
          # ìµœì‹  5ê°œ ì»¤ë°‹ ë©”ì‹œì§€ ìˆ˜ì§‘
          commits=$(git log -n 5 --pretty=format:"- %s")
          # ENVì— ë©€í‹°ë¼ì¸ ë¬¸ìì—´ë¡œ ì €ì¥í•˜ê¸° (EOF êµ¬ë¶„ì ì—†ì´ ê°„ë‹¨í•˜ê²Œ ì²˜ë¦¬)
          echo "COMMITS<<EOF" >> $GITHUB_ENV
          echo "$commits" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Wait for Netlify Deploy to Finish
        run: sleep 30

      - name: Send Slack Notification
        env:
          SLACK_FROM_NETLIFY_URL: ${{ secrets.SLACK_FROM_NETLIFY_URL }}
        run: |
          # COMMITS ê°’ì„ ì•ˆì „í•˜ê²Œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬: ì¤„ë°”ê¿ˆì„ \\nìœ¼ë¡œ ì¹˜í™˜
          commits_escaped=$(printf "%s" "$COMMITS" | sed ':a;N;$!ba;s/\n/\\n/g')
          payload="{\"text\":\"ğŸ·ì„¸ìƒì—!! ìƒˆë¡œìš´ ë°°í¬ ë²„ì „ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆì§€ ë­ì•¼??!!\\nğŸ”— https://likelionhackathon.netlify.app\\n\\nì´ë²ˆ ë°°í¬ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì»¤ë°‹ì´ ë°œìƒí–ˆì–´ìš”:\\n$commits_escaped\"}"
          curl -X POST -H 'Content-type: application/json' \
            --data "$payload" \
            "$SLACK_FROM_NETLIFY_URL"
